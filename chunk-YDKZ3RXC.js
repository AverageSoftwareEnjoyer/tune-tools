import{a as l}from"./chunk-KNLYK6FS.js";import{a as A,c as C,n as E,p as P}from"./chunk-RTHZNNEU.js";import{D as x,J as R,Q as j,_ as w,ba as y,d as e,e as h,ea as f,f as S,g as $,ka as u,p as _,q as v,r as b,x as k}from"./chunk-W2QO6QT6.js";var z=(()=>{var r,o;let i=class i{constructor(){h(this,r,!1);h(this,o,!1)}get isUserAuthenticated(){return e(this,r)}set isUserAuthenticated(a){S(this,r,a)}get isUserAuthorized(){return e(this,o)}set isUserAuthorized(a){S(this,o,a)}};r=new WeakMap,o=new WeakMap,i.\u0275fac=function(d){return new(d||i)},i.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"});let c=i;return c})();var F=(()=>{var r;let o=class o{constructor(){h(this,r,u(C))}getAccessToken$(t,a){let d=new A().set("client_id",l.clientId).set("grant_type","authorization_code").set("redirect_uri",l.redirectUri).set("code",a).set("code_verifier",t);return e(this,r).post(l.tokenUrl,d,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}refreshAccessToken$(t){let a=new A().set("client_id",l.clientId).set("grant_type","refresh_token").set("refresh_token",t);return e(this,r).post(l.tokenUrl,a,{headers:{"Content-Type":"application/x-www-form-urlencoded"}})}};r=new WeakMap,o.\u0275fac=function(a){return new(a||o)},o.\u0275prov=f({token:o,factory:o.\u0275fac,providedIn:"root"});let c=o;return c})();var H=["verifier","access_token","refresh_token","token_expiry","state"];var L=(()=>{let r=class r{setItem(i,t){localStorage.setItem(`__${i}`,t)}getItem(i){return localStorage.getItem(`__${i}`)}removeItem(i){localStorage.removeItem(`__${i}`)}clearLocalStorageItems(){for(let i of H)this.removeItem(i)}};r.\u0275fac=function(t){return new(t||r)},r.\u0275prov=f({token:r,factory:r.\u0275fac,providedIn:"root"});let c=r;return c})();var ne=(()=>{var r,o,i,t,a,d,T;let g=class g{constructor(){h(this,d);h(this,r,u(E));h(this,o,u(F));h(this,i,u(z));h(this,t,u(L));h(this,a,u(P))}generateRandomString(n){let s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(n)).reduce((m,I)=>m+s[I%s.length],"")}sha256$(n){let p=new TextEncoder().encode(n);return v(crypto.subtle.digest("SHA-256",p))}base64encode(n){return btoa(String.fromCharCode(...new Uint8Array(n))).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}redirectToAuthCodeFlow$(){let n,s=this.generateRandomString(128),p=this.generateRandomString(128);return x([this.sha256$(s),this.sha256$(p)]).pipe(k(([m,I])=>[this.base64encode(m),this.base64encode(I)]),y(([,m])=>{e(this,t).setItem("verifier",s),e(this,t).setItem("state",m)}),y(([m,I])=>{let B=new A().set("client_id",l.clientId).set("response_type","code").set("redirect_uri",l.redirectUri).set("scope",l.scope).set("code_challenge_method","S256").set("code_challenge",m).set("state",I);n=`${l.authUrl}?${B.toString()}`}),k(()=>!1),j(()=>window.location.href=n))}handleAuthCallback$(){return e(this,r).queryParams.pipe(w(({code:n,state:s})=>!n||!s||s!==e(this,t).getItem("state")?(e(this,t).clearLocalStorageItems(),v(e(this,a).navigateByUrl(""))):(e(this,t).removeItem("state"),this.getAccessTokenWrapper$(n))))}getAccessTokenWrapper$(n){let s=e(this,t).getItem("verifier");return s?e(this,o).getAccessToken$(s,n).pipe(R(()=>this.logoutAndRedirect$().pipe(w(()=>_))),y(({access_token:p,refresh_token:m})=>{$(this,d,T).call(this,p,m),e(this,t).removeItem("verifier")}),w(()=>v(e(this,a).navigateByUrl("/top-tracks")))):this.logoutAndRedirect$()}handlePotentiallyExpiredAccessToken$(){let n=e(this,t).getItem("access_token"),s=e(this,t).getItem("refresh_token"),p=e(this,t).getItem("token_expiry");return!n||!s||!p?this.logoutAndRedirect$().pipe(k(()=>!1)):new Date>new Date(parseInt(p))?e(this,o).refreshAccessToken$(s).pipe(y(({access_token:m,refresh_token:I})=>{$(this,d,T).call(this,m,I)}),k(()=>!0)):b(!0)}logoutAndRedirect$(){return e(this,i).isUserAuthenticated=!1,e(this,t).clearLocalStorageItems(),v(e(this,a).navigateByUrl(""))}};r=new WeakMap,o=new WeakMap,i=new WeakMap,t=new WeakMap,a=new WeakMap,d=new WeakSet,T=function(n,s){e(this,i).isUserAuthenticated=!0,e(this,t).setItem("access_token",n),e(this,t).setItem("refresh_token",s);let p=new Date().getTime()+36e5;e(this,t).setItem("token_expiry",p.toString())},g.\u0275fac=function(s){return new(s||g)},g.\u0275prov=f({token:g,factory:g.\u0275fac,providedIn:"root"});let c=g;return c})();export{z as a,L as b,ne as c};
//# sourceMappingURL=chunk-YDKZ3RXC.js.map
